import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Slider } from '@/components/ui/slider';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

const FXRiskDashboard = () => {
  // Baseline data from the Excel file
  const baselineData = {
    monthlyFXExposure: [-244913.1383559679, -582492.5397071253, -595985.0428778412, -246269.09751139852, -227072.9735906436, -287223.4118427991, -310807.28302577627, -327908.8959023253, -328137.6167722435, -320395.9865059182, -317530.68876220554, -310753.34235342825],
    monthlyPLExposure: [-134787.43164596788, -149519.92506115738, -149133.11681668373, -83022.44969471474, -129761.2768115427, -142961.93886248406, -153345.14799451985, -160063.55173903308, -153573.86886443806, -152321.9214727078, -150708.5711207253, -145544.57506393053],
    months: ['Jan-25', 'Feb-25', 'Mar-25', 'Apr-25', 'May-25', 'Jun-25', 'Jul-25', 'Aug-25', 'Sep-25', 'Oct-25', 'Nov-25', 'Dec-25'],
    
    // Excel dashboard data structure
    operationalStrategy: {
      contractualSales: [35225, 3378, 5304, 2517, 2482, 2693, 2693, 2693, 2693, 2693, 2693, 2693, 2693],
      icSales: [618455, 67891, 63857, 71648, 75454, 51738, 53601, 48031, 35015, 39632, 42662, 35488, 33438],
      forecastedPurchases: [-522343, -62086, -55911, -59751, -45981, -44855, -41355, -35296, -35412, -35122, -36711, -35919, -33944],
      variableContributionMargin: [-1704743.78, -134787.43, -149519.93, -149133.12, -83022.45, -129761.28, -142961.94, -153345.15, -160063.55, -153573.87, -152321.92, -150708.57, -145544.58]
    },
    
    balanceSheetData: {
      cashEquivalents: [12808, 1141, 1239, 1050, 1064, 1001, 1001, 1252, 1395, 978, 934, 1550, 2493],
      arIC: [49772, 23533, 17478, 17825, 18656, 14079, 15536, 12713, 9546, 9835, 10500, 9198, 8527],
      longPosition: [65580, 64910, 29160, 32024, 35337, 33453, 37603, 37474, 36999, 39982, 43339, 44730, 46752],
      apThirdParty: [-40382, -62086, -77614, -75280, -65350, -50453, -45827, -36268, -30325, -30152, -31451, -32248, -29481],
      shortPosition: [-40382, -62086, -77614, -75280, -65350, -50453, -45827, -36268, -30325, -30152, -31451, -32248, -29481],
      fxLossesPosition: [25197, 2824, -48455, -43255, -30013, -17000, -8224, 1206, 6674, 9830, 11887, 12482, 17271],
      ebitdaPosition: [25197, 2824, -48455, -43255, -30013, -17000, -8224, 1206, 6674, 9830, 11887, 12482, 17271]
    }
  };

  // Control states
  const [apPaymentDays, setApPaymentDays] = useState([30]);
  const [arCollectionDays, setArCollectionDays] = useState([45]);
  const [hedgeRatio, setHedgeRatio] = useState([0]);
  const [usdMxnRate, setUsdMxnRate] = useState([20.0]);
  const [volatility, setVolatility] = useState([19.5]);
  const [confidenceLevel, setConfidenceLevel] = useState(['95']);

  // Adjusted values based on controls
  const [adjustedData, setAdjustedData] = useState(baselineData);

  // Calculate adjustments based on control changes
  useEffect(() => {
    const calculateAdjustments = () => {
      const apImpact = (30 - apPaymentDays[0]) / 30 * 0.15;
      const arImpact = (45 - arCollectionDays[0]) / 45 * 0.2;
      const hedgeImpact = hedgeRatio[0] / 100;
      const rateImpact = (usdMxnRate[0] - 20.0) / 20.0;

      // Adjust all the data arrays
      const newData = { ...baselineData };
      
      // Adjust operational strategy
      newData.operationalStrategy = {
        ...baselineData.operationalStrategy,
        variableContributionMargin: baselineData.operationalStrategy.variableContributionMargin.map(val => 
          val * (1 + apImpact + arImpact + rateImpact) * (1 - hedgeImpact)
        )
      };

      // Adjust balance sheet data
      newData.balanceSheetData = {
        ...baselineData.balanceSheetData,
        fxLossesPosition: baselineData.balanceSheetData.fxLossesPosition.map(val => 
          val * (1 + apImpact + arImpact + rateImpact) * (1 - hedgeImpact)
        ),
        ebitdaPosition: baselineData.balanceSheetData.ebitdaPosition.map(val => 
          val * (1 + apImpact + arImpact + rateImpact) * (1 - hedgeImpact)
        )
      };

      setAdjustedData(newData);
    };

    calculateAdjustments();
  }, [apPaymentDays, arCollectionDays, hedgeRatio, usdMxnRate, volatility, confidenceLevel]);

  // Format numbers for display
  const formatNumber = (num, showSign = false) => {
    if (num === undefined || num === null || isNaN(num)) {
      return '0';
    }
    
    const numValue = Number(num);
    const formatted = numValue.toLocaleString('en-US', { 
      minimumFractionDigits: 0, 
      maximumFractionDigits: 0 
    });
    
    if (showSign && numValue > 0) {
      return `+${formatted}`;
    }
    return formatted;
  };

  // Excel-style table component
  const ExcelTable = ({ title, data, headers, backgroundColor = "bg-gray-50" }) => (
    <div className="mb-6">
      <div className={`${backgroundColor} p-3 border-b-2 border-gray-300`}>
        <h3 className="font-bold text-gray-800">{title}</h3>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full border-collapse text-sm">
          <thead>
            <tr className="bg-gray-100">
              <th className="border border-gray-300 p-2 text-left font-semibold">Item</th>
              <th className="border border-gray-300 p-2 text-right font-semibold">12mo Forecast</th>
              {baselineData.months.map(month => (
                <th key={month} className="border border-gray-300 p-2 text-right font-semibold">{month}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.map((row, index) => (
              <tr key={index} className={index % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                <td className="border border-gray-300 p-2 font-medium">{row.label}</td>
                <td className="border border-gray-300 p-2 text-right">{formatNumber(row.annual)}</td>
                {row.monthly.map((value, monthIndex) => (
                  <td key={monthIndex} className={`border border-gray-300 p-2 text-right ${value < 0 ? 'text-red-600' : ''}`}>
                    {formatNumber(value)}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  // VaR Report section (matching your Excel format)
  const VaRReportSection = () => {
    const varParams = {
      volatility: volatility[0] / 100,
      confidenceInterval: parseInt(confidenceLevel[0]) / 100,
      timeHorizon: Math.sqrt(1/12)
    };

    const confidenceMultiplier = confidenceLevel[0] === '95' ? 1.645 : confidenceLevel[0] === '99' ? 2.326 : 1.282;
    const variableContributionExposure = adjustedData.operationalStrategy.variableContributionMargin[0]; // Annual
    const plValueAtRisk = Math.abs(variableContributionExposure) * varParams.volatility * varParams.timeHorizon * confidenceMultiplier;
    
    const unrealizedFXExposure = adjustedData.balanceSheetData.fxLossesPosition[0];
    const bsValueAtRisk = Math.abs(unrealizedFXExposure) * varParams.volatility * varParams.timeHorizon * confidenceMultiplier;

    return (
      <div className="bg-blue-50 p-6 rounded-lg mb-6">
        <h2 className="text-xl font-bold text-blue-900 mb-4">FX Management Financial Statement Impact - Mexico</h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <div className="bg-white p-4 rounded border">
              <div className="text-sm text-gray-600 mb-2">Date: {new Date().toLocaleDateString()}</div>
              <div className="text-sm text-gray-600 mb-2">Functional Currency: MXN</div>
              <div className="text-sm text-gray-600">Exposure: USD</div>
            </div>
          </div>
          
          <div>
            <div className="bg-white p-4 rounded border">
              <div className="text-sm text-gray-600 mb-2">Transactional Currency: USD</div>
              <div className="text-sm text-gray-600 mb-2">Functional Currency: MXN</div>
              <div className="text-sm text-gray-600">Region: Mexico</div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
          <div className="bg-white p-4 rounded border">
            <div className="text-center">
              <div className="text-sm text-gray-600 mb-2">Variable Contribution Margin Exposure</div>
              <div className="text-2xl font-bold text-red-600">{formatNumber(variableContributionExposure)}</div>
              <div className="text-sm text-gray-600 mt-2">P&L Value at Risk</div>
              <div className="text-xl font-bold text-orange-600">{formatNumber(plValueAtRisk)}</div>
            </div>
          </div>

          <div className="bg-white p-4 rounded border">
            <div className="text-center">
              <div className="text-sm text-gray-600 mb-2">Unrealized FX Exposure</div>
              <div className="text-2xl font-bold text-blue-600">{formatNumber(unrealizedFXExposure)}</div>
              <div className="text-sm text-gray-600 mt-2">B/S Value at Risk</div>
              <div className="text-xl font-bold text-green-600">{formatNumber(bsValueAtRisk)}</div>
            </div>
          </div>
        </div>

        <div className="bg-white p-4 rounded border mt-6">
          <h4 className="font-bold text-gray-800 mb-3">Value at Risk Parameters</h4>
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div>
              <span className="text-gray-600">Volatility:</span>
              <span className="ml-2 font-semibold">{(volatility[0] / 100).toFixed(3)}</span>
            </div>
            <div>
              <span className="text-gray-600">Confidence Interval:</span>
              <span className="ml-2 font-semibold">{(parseInt(confidenceLevel[0]) / 100).toFixed(2)}</span>
            </div>
            <div>
              <span className="text-gray-600">Time Horizon:</span>
              <span className="ml-2 font-semibold">{varParams.timeHorizon.toFixed(3)} (Monthly)</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="flex h-screen bg-gray-50">
      {/* Left Control Panel */}
      <div className="w-80 bg-white shadow-lg p-6 overflow-y-auto">
        <h2 className="text-xl font-bold text-gray-800 mb-6">FX Risk Controls</h2>
        
        {/* Payment Terms Section */}
        <Card className="mb-4">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-semibold text-blue-700">Payment Terms</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                AP Payment Days: {apPaymentDays[0]}
              </label>
              <Slider
                value={apPaymentDays}
                onValueChange={setApPaymentDays}
                max={90}
                min={15}
                step={5}
                className="w-full"
              />
            </div>
            
            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                AR Collection Days: {arCollectionDays[0]}
              </label>
              <Slider
                value={arCollectionDays}
                onValueChange={setArCollectionDays}
                max={75}
                min={15}
                step={5}
                className="w-full"
              />
            </div>
          </CardContent>
        </Card>

        {/* Hedging Strategy Section */}
        <Card className="mb-4">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-semibold text-green-700">Hedging Strategy</CardTitle>
          </CardHeader>
          <CardContent>
            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                Hedge Ratio: {hedgeRatio[0]}%
              </label>
              <Slider
                value={hedgeRatio}
                onValueChange={setHedgeRatio}
                max={100}
                min={0}
                step={5}
                className="w-full"
              />
            </div>
          </CardContent>
        </Card>

        {/* Market Scenarios Section */}
        <Card className="mb-4">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-semibold text-purple-700">Market Scenarios</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                USD/MXN Rate: {usdMxnRate[0].toFixed(2)}
              </label>
              <Slider
                value={usdMxnRate}
                onValueChange={setUsdMxnRate}
                max={25}
                min={15}
                step={0.1}
                className="w-full"
              />
            </div>

            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                Volatility: {volatility[0]}%
              </label>
              <Slider
                value={volatility}
                onValueChange={setVolatility}
                max={35}
                min={10}
                step={0.5}
                className="w-full"
              />
            </div>

            <div>
              <label className="text-xs font-medium text-gray-600 mb-2 block">
                Confidence Level
              </label>
              <Select value={confidenceLevel[0]} onValueChange={(value) => setConfidenceLevel([value])}>
                <SelectTrigger className="w-full">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="90">90%</SelectItem>
                  <SelectItem value="95">95%</SelectItem>
                  <SelectItem value="99">99%</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Main Dashboard - Excel Style */}
      <div className="flex-1 p-6 overflow-y-auto">
        <h1 className="text-2xl font-bold text-gray-800 mb-6">FX Risk Management Dashboard</h1>
        
        {/* VaR Report Section */}
        <VaRReportSection />

        {/* Operational Strategy */}
        <ExcelTable 
          title="Operational Strategy"
          backgroundColor="bg-blue-50"
          data={[
            {
              label: "Contractual Sales",
              annual: adjustedData.operationalStrategy.contractualSales[0],
              monthly: adjustedData.operationalStrategy.contractualSales.slice(1)
            },
            {
              label: "IC Sales", 
              annual: adjustedData.operationalStrategy.icSales[0],
              monthly: adjustedData.operationalStrategy.icSales.slice(1)
            },
            {
              label: "Forecasted Purchases",
              annual: adjustedData.operationalStrategy.forecastedPurchases[0],
              monthly: adjustedData.operationalStrategy.forecastedPurchases.slice(1)
            },
            {
              label: "Position Exposed on Variable Contribution Margin",
              annual: adjustedData.operationalStrategy.variableContributionMargin[0],
              monthly: adjustedData.operationalStrategy.variableContributionMargin.slice(1)
            }
          ]}
        />

        {/* Balance Sheet Management */}
        <ExcelTable 
          title="Balance Sheet Management"
          backgroundColor="bg-green-50"
          data={[
            {
              label: "Cash & cash equivalents",
              annual: adjustedData.balanceSheetData.cashEquivalents[0],
              monthly: adjustedData.balanceSheetData.cashEquivalents.slice(1)
            },
            {
              label: "AR - IC",
              annual: adjustedData.balanceSheetData.arIC[0],
              monthly: adjustedData.balanceSheetData.arIC.slice(1)
            },
            {
              label: "Long Position",
              annual: adjustedData.balanceSheetData.longPosition[0],
              monthly: adjustedData.balanceSheetData.longPosition.slice(1)
            },
            {
              label: "AP - 3rd Party",
              annual: adjustedData.balanceSheetData.apThirdParty[0],
              monthly: adjustedData.balanceSheetData.apThirdParty.slice(1)
            },
            {
              label: "Short Position",
              annual: adjustedData.balanceSheetData.shortPosition[0],
              monthly: adjustedData.balanceSheetData.shortPosition.slice(1)
            },
            {
              label: "Position to impact Foreign Exchange Losses",
              annual: adjustedData.balanceSheetData.fxLossesPosition[0],
              monthly: adjustedData.balanceSheetData.fxLossesPosition.slice(1)
            },
            {
              label: "Position Exposed on EBTDA",
              annual: adjustedData.balanceSheetData.ebitdaPosition[0],
              monthly: adjustedData.balanceSheetData.ebitdaPosition.slice(1)
            }
          ]}
        />
      </div>
    </div>
  );
};

export default FXRiskDashboard;
